<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>動物SNSデモ（Firebase版）</title>
<style>
  body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
  #feed { border: 1px solid #ccc; padding: 10px; min-height: 300px; margin-bottom: 10px; overflow-y: auto; }
  #feed div { margin-bottom: 8px; }
  #comment { width: 80%; }
</style>
</head>
<body>

<h2>動物SNSデモ（Firebase版）</h2>
<div id="register">
  <input type="text" id="nameInput" placeholder="ユーザー名を入力">
  <button id="registerBtn">登録</button>
</div>

<div id="status" style="margin-top:10px;"></div>
<div id="feed"></div>
<input type="text" id="comment" placeholder="コメントを入力">
<button id="send">送信</button>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
// ===== Firebase設定 =====
// 自分のFirebaseプロジェクト情報に書き換えてください
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// ===== 動物設定 =====
const animals = ['dog','cat','horse','rabbit'];
const animalNames = {dog:'犬', cat:'猫', horse:'馬', rabbit:'ウサギ'};
let myAnimal = null;
let myName = null;

function toAnimalLanguage(text, animal){
  switch(animal){
    case 'dog': return 'ワンワンワン';
    case 'cat': return 'ニャーニャー';
    case 'horse': return 'ヒヒーンヒヒヒーン';
    case 'rabbit': return 'ピョンピョン';
    default: return text;
  }
}

// ===== 登録処理 =====
document.getElementById('registerBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('nameInput').value.trim();
  if(!name){ alert('名前を入力してください'); return; }

  const userRef = db.collection('users').doc(name);
  const doc = await userRef.get();
  if(doc.exists){ alert('この名前は既に使われています'); return; }

  myAnimal = animals[Math.floor(Math.random()*animals.length)];
  myName = name;
  await userRef.set({animal: myAnimal});
  document.getElementById('status').innerText = `あなたは ${animalNames[myAnimal]} です`;
  document.getElementById('register').style.display = 'none';
  startRealtimeFeed();
});

// ===== コメント送信 =====
document.getElementById('send').addEventListener('click', sendComment);
document.getElementById('comment').addEventListener('keypress', e=>{
  if(e.key==='Enter') sendComment();
});

async function sendComment(){
  const text = document.getElementById('comment').value.trim();
  if(!text) return;
  await db.collection('comments').add({userName: myName, animal: myAnimal, text, timestamp: Date.now()});
  document.getElementById('comment').value = '';

  // 最新50件保持
  const snapshot = await db.collection('comments').orderBy('timestamp').get();
  if(snapshot.size > 50){
    const toDelete = snapshot.docs.slice(0, snapshot.size - 50);
    toDelete.forEach(doc=>doc.ref.delete());
  }
}

// ===== リアルタイムフィード =====
function startRealtimeFeed(){
  db.collection('comments').orderBy('timestamp')
    .onSnapshot(snapshot=>{
      const feed = document.getElementById('feed');
      feed.innerHTML = '';
      snapshot.forEach(doc=>{
        const data = doc.data();
        const displayText = (data.animal === myAnimal) ? data.text : toAnimalLanguage(data.text, data.animal);
        const div = document.createElement('div');
        div.innerText = `${animalNames[data.animal]}(${data.userName}): ${displayText}`;
        feed.appendChild(div);
      });
      feed.scrollTop = feed.scrollHeight;
    });
}
</script>

</body>
</html>
