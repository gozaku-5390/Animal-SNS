<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>動物SNSデモ（匿名ログイン版）</title>
<style>
  body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
  #feed { border: 1px solid #ccc; padding: 10px; min-height: 300px; margin-bottom: 10px; overflow-y: auto; }
  #feed div { margin-bottom: 8px; }
  #comment { width: 80%; }
</style>
</head>
<body>

<h2>動物SNSデモ（匿名ログイン版）</h2>
<div id="register">
  <input type="text" id="nameInput" placeholder="ユーザー名を入力">
  <button id="registerBtn">登録</button>
</div>

<div id="status" style="margin-top:10px;"></div>
<div id="feed"></div>
<input type="text" id="comment" placeholder="コメントを入力">
<button id="send">送信</button>

<script type="module">
  // ===== Firebase初期化 =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, onSnapshot, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBFZ1ys81JAynYIcCAWkqDfu4rpMOm7u2A",
    authDomain: "animal-sns-c4bf0.firebaseapp.com",
    projectId: "animal-sns-c4bf0",
    storageBucket: "animal-sns-c4bf0.appspot.com",
    messagingSenderId: "142723090731",
    appId: "1:142723090731:web:248c708042ffd2daf7dd6e",
    measurementId: "G-D3M0TYT3EC"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // 匿名ログイン
  signInAnonymously(auth)
    .then(() => console.log("匿名ログイン成功"))
    .catch(err => console.error("匿名ログイン失敗", err));

  // ===== 動物設定 =====
  const animals = ['dog','cat','horse','rabbit'];
  const animalNames = {dog:'犬', cat:'猫', horse:'馬', rabbit:'ウサギ'};
  let myAnimal = null;
  let myName = null;

  function toAnimalLanguage(text, animal){
    switch(animal){
      case 'dog': return 'ワンワンワン';
      case 'cat': return 'ニャーニャー';
      case 'horse': return 'ヒヒーンヒヒヒーン';
      case 'rabbit': return 'ピョンピョン';
      default: return text;
    }
  }

  // ===== 登録処理 =====
  document.getElementById('registerBtn').addEventListener('click', async ()=>{
    const name = document.getElementById('nameInput').value.trim();
    if(!name){ alert('名前を入力してください'); return; }

    // 名前重複チェック
    const userRef = doc(db, 'users', name);
    const snapshot = await getDocs(query(collection(db, 'users')));
    if(snapshot.docs.some(d => d.id === name)){
      alert('この名前は既に使われています'); return;
    }

    myAnimal = animals[Math.floor(Math.random()*animals.length)];
    myName = name;
    await setDoc(userRef, {animal: myAnimal, uid: auth.currentUser.uid});

    document.getElementById('status').innerText = `あなたは ${animalNames[myAnimal]} です`;
    document.getElementById('register').style.display = 'none';
    startRealtimeFeed();
  });

  // ===== コメント送信 =====
  document.getElementById('send').addEventListener('click', sendComment);
  document.getElementById('comment').addEventListener('keypress', e=>{
    if(e.key==='Enter') sendComment();
  });

  async function sendComment(){
    if(!auth.currentUser) return;
    const text = document.getElementById('comment').value.trim();
    if(!text) return;

    await addDoc(collection(db,'comments'), {
      userName: myName,
      animal: myAnimal,
      text,
      timestamp: Date.now(),
      uid: auth.currentUser.uid
    });
    document.getElementById('comment').value = '';

    // 最新50件保持
    const q = query(collection(db,'comments'), orderBy('timestamp'));
    const snap = await getDocs(q);
    if(snap.size > 50){
      snap.docs.slice(0, snap.size - 50).forEach(docSnap => docSnap.ref.delete());
    }
  }

  // ===== リアルタイムフィード =====
  function startRealtimeFeed(){
    const q = query(collection(db,'comments'), orderBy('timestamp'));
    onSnapshot(q, snapshot=>{
      const feed = document.getElementById('feed');
      feed.innerHTML = '';
      snapshot.forEach(docSnap=>{
        const data = docSnap.data();
        const displayText = (data.animal === myAnimal) ? data.text : toAnimalLanguage(data.text, data.animal);
        const div = document.createElement('div');
        div.innerText = `${animalNames[data.animal]}(${data.userName}): ${displayText}`;
        feed.appendChild(div);
      });
      feed.scrollTop = feed.scrollHeight;
    });
  }
</script>

</body>
</html>
